name: ğŸ§¹ RGPD Automatic Cleanup

on:
  # ExÃ©cution automatique tous les jours Ã  3h du matin (UTC)
  schedule:
    - cron: "0 3 * * *"

  # Permet l'exÃ©cution manuelle depuis GitHub Actions
  workflow_dispatch:
    inputs:
      force_execution:
        description: "Force execution even if no data to purge"
        required: false
        default: "false"
        type: boolean

jobs:
  rgpd-cleanup:
    runs-on: ubuntu-latest
    name: ğŸ›¡ï¸ Execute RGPD Data Purges

    steps:
      - name: ğŸ“‹ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Execute RGPD Purge Function
        id: purge
        run: |
          echo "ğŸ§¹ Starting RGPD automatic cleanup..."

          # Appel de l'Edge Function Supabase
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            "${{ vars.SUPABASE_URL }}/functions/v1/scheduled-cleanup")

          # Extraction du code de retour HTTP
          http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          response_body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')

          echo "HTTP Status: $http_code"
          echo "Response: $response_body"

          # VÃ©rification du succÃ¨s
          if [ "$http_code" == "200" ]; then
            echo "âœ… RGPD purge executed successfully"
            echo "Response: $response_body"
            
            # Parser le nombre de purges exÃ©cutÃ©es
            purges_count=$(echo "$response_body" | grep -o '"purges_executed":[0-9]*' | cut -d':' -f2)
            echo "ğŸ“Š Purges executed: $purges_count"
            
            # DÃ©finir la sortie pour les Ã©tapes suivantes
            echo "purges_executed=$purges_count" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ RGPD purge failed with HTTP $http_code"
            echo "Error response: $response_body"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“Š Report Results
        if: always()
        run: |
          if [ "${{ steps.purge.outputs.success }}" == "true" ]; then
            echo "ğŸ‰ RGPD Cleanup completed successfully!"
            echo "ğŸ“ˆ Statistics:"
            echo "  â€¢ Purges executed: ${{ steps.purge.outputs.purges_executed }}"
            echo "  â€¢ Execution time: $(date -u)"
            echo "  â€¢ Next scheduled run: Tomorrow at 3:00 AM UTC"
          else
            echo "ğŸš¨ RGPD Cleanup failed!"
            echo "Please check the logs above for error details."
          fi

      - name: ğŸ”” Notify on Failure (Optional)
        if: failure()
        run: |
          echo "ğŸš¨ RGPD Cleanup Job Failed!"
          echo "Timestamp: $(date -u)"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          # Ajoutez ici une notification Slack/Discord si nÃ©cessaire

# =====================================================
# ğŸ”§ CONFIGURATION REQUISE
# =====================================================
#
# Repository Settings > Secrets and variables > Actions:
#
# SECRETS (tab "Secrets"):
# 1. SUPABASE_ANON_KEY
#    Valeur: Votre clÃ© publique Supabase (anon key)
#
# VARIABLES (tab "Variables"):
# 2. SUPABASE_URL
#    Valeur: https://your-project-id.supabase.co
#
# OPTIONNEL:
# 3. CLEANUP_API_TOKEN (secret)
#    Valeur: Token personnalisÃ© pour sÃ©curiser l'endpoint
#
# =====================================================
# ğŸ“‹ FONCTIONNEMENT
# =====================================================
#
# â° ExÃ©cution automatique: Tous les jours Ã  3h du matin UTC
# ğŸ¯ Action: Appelle votre Edge Function scheduled-cleanup
# ğŸ“Š RÃ©sultat: Purge les utilisateurs supprimÃ©s depuis 3+ ans
# ğŸ” Monitoring: Logs dÃ©taillÃ©s dans GitHub Actions
# ğŸš¨ Alertes: Ã‰chec visible dans l'onglet Actions
#
# =====================================================
